<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Wind Field</title>
    <link href="./static/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="./static/js/config.js"></script>
    <script src="./static/js/jquery.min.js"></script>
    <link href="./static/css/pretty.css" rel="stylesheet"> 
    <script src="./static/js/config.js"></script>
    <script type="text/javascript" src="./static/Cesium/Cesium.js"></script>
</head>
<body>
<div id="cesiumContainer"></div>
<div id="toolbar" class="tool-bar param-container">
    <div class="param-item">
        <label>粒子大小: </label>
        <input type="range" id="particleSize" min="1" max="10" value="2" step="1" style="width: 170px">
    </div>
    <div class="param-item">
        <label>生命周期: </label>
        <input type="range" id="particleLife" min="1" max="20" value="5" step="1" style="width: 170px">
    </div>
    <div class="param-item">
        <label>粒子密度: </label>
        <input type="range" id="particleDensity" min="0.1" max="3" value="1" step="0.1" style="width: 170px">
    </div>
    <div class="param-item">
        <label>粒子速度: </label>
        <input type="range" id="particleVelocityScale" min="0.1" max="50" value="40" step="1" style="width: 170px">
    </div>
    <div class="param-item">
        <label>图层可见性 </label>
        <input type="checkbox" id="fieldLayerVisible" checked=true>
    </div>
    <div class="param-item">
        <label>场景泛光</label>
        <input type="checkbox" id="show" checked>
    </div>
    <div class="param-item">
        <label>亮度阈值: </label>
        <input type="range" id="threshold" min="0" max="1" value="0.5" step="0.1" style="width: 170px">
    </div>
    <div class="param-item">
        <label>泛光强度: </label>
        <input type="range" id="bloomIntensity" min="0" max="10" value="2" step="0.1" style="width: 170px">
    </div>
    <div class="param-item">
        <button type="button" id="startField" class="button black">启动风场</button>
        <button type="button" id="changeFieldData" class="button black" style="margin-left: 49px;">切换数据</button>
    </div>
</div>
<script>
    function onload(Cesium) {
        var viewer = new Cesium.Viewer('cesiumContainer', {
            contextOptions: {
                requestWebgl2: true
            },
            infobox: false,
            skyAtmosphere: false
        });

        // var imageryLayers = viewer.imageryLayers;
        // //初始化天地图全球中文注记服务，并添加至影像图层
        // var labelImagery = new Cesium.TiandituImageryProvider({
        //     mapStyle : Cesium.TiandituMapsStyle.CIA_C, //天地图全球中文注记服务（经纬度投影）
        //     token: URL_CONFIG.TOKEN_TIANDITU
        // });
        // imageryLayers.addImageryProvider(labelImagery);

        // viewer.imageryLayers.addImageryProvider(
        //     new Cesium.UrlTemplateImageryProvider({
        //         url:
        //             "http://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"
        //     })
        // );

        // viewer.imageryLayers.addImageryProvider(new Cesium.BingMapsImageryProvider({
        //     key: URL_CONFIG.BING_MAP_KEY,//可至官网（https://www.bingmapsportal.com/）申请key
        //     url: URL_CONFIG.BINGMAP
        // }));

		viewer.imageryLayers.addImageryProvider(new Cesium.SuperMapImageryProvider({
            url: 'https://maptiles.supermapol.com/iserver/services/map_China/rest/maps/China_Dark'
        }));

        var scene = viewer.scene;
        scene.skyBox.show = false;
        viewer.scene.skyBox.show = false;
        viewer.scene.sun.show = false;
        // viewer.scene.bloomEffect.show = true; //启用泛光效果
        viewer.scene.bloomEffect.threshold = $("#threshold").val();
        viewer.scene.bloomEffect.bloomIntensity = $("#bloomIntensity").val();


        var colorTable = new Cesium.ColorTable();
        var fieldLayer = new Cesium.FieldLayer3D(scene.context); //场数据图层
        fieldLayer.particleVelocityFieldEffect.velocityScale = 40; //初始化效果
        fieldLayer.particleVelocityFieldEffect.particleSize = 2;
        fieldLayer.particleVelocityFieldEffect.paricleCountPerDegree = 1.0;
        // fieldLayer.particleVelocityFieldEffect._fade0pacity=0.996;
        scene.primitives.add(fieldLayer); //添加场图层
        var particleWindField = [];
        var particleWindInverseField = [];
        var dataChanged = false;


        var minValue = 0, maxValue = 0;


        //加载风场数据
        $.ajax({
            url: './static/data/gfs.t18z.pgrb2.1p00.json',
            success: function (data) {
                var p = 0;
                for (var j = 0; j < 181; j++) {
                    particleWindField[j] = [];
                    particleWindInverseField[j] = [];
                    for (var i = 0; i < 360; i++, p++) {
                        var idx = i < 180 ? i + 180 : i - 180;
                        var offset = (180 - j) * 360 + idx;
                        var wind_value = [data[1].data[offset], data[2].data[offset]];

                        var speed = Math.sqrt(wind_value[0] * wind_value[0] + wind_value[1] * wind_value[1]);

                        if (speed < minValue) {
                            minValue = speed;
                        }
                        if (speed > maxValue) {
                            maxValue = speed;
                        }
                        particleWindField[j][i] = wind_value;
                        particleWindInverseField[j][i] = [-wind_value[0], -wind_value[1]];
                    }
                }

                var colorTable = new Cesium.ColorTable();

                colorTable.insert(0, new Cesium.Color.fromCssColorString('#6EB1EE'))  // 0级  0-0.2m/s
                colorTable.insert(0.2, new Cesium.Color.fromCssColorString('#68ACED'))  //1级  0.2-1.5m/s
                colorTable.insert(1.5, new Cesium.Color.fromCssColorString('#61A7EB'))     //2级  1.5-3.3m/s
                colorTable.insert(3.3, new Cesium.Color.fromCssColorString('#5BA2EA'))    //3级  3.3-5.4m/s
                colorTable.insert(5.4, new Cesium.Color.fromCssColorString('#549DE9'))   //4级  5.4-7.9m/s
                colorTable.insert(7.9, new Cesium.Color.fromCssColorString('#4E98E8'))    //5级  7.9-10.7m/s
                colorTable.insert(10.7, new Cesium.Color.fromCssColorString('#4794E6'))  //6级  10.7-13.8m/s
                colorTable.insert(13.8, new Cesium.Color.fromCssColorString('#418FE5'))  //7级  13.8-17.1m/s
                colorTable.insert(17.1, new Cesium.Color.fromCssColorString('#3A8AE4'))   //8级  17.1-20.7m/s
                colorTable.insert(20.7, new Cesium.Color.fromCssColorString('#3485E3'))   //9级  20.7-24.4m/s
                colorTable.insert(24.4, new Cesium.Color.fromCssColorString('#2D80E2'))  //10级  24.4-28.4m/s
                colorTable.insert(28.4, new Cesium.Color.fromCssColorString('#277BE0'))  //11级  28.4-32.6m/s
                colorTable.insert(32.6, new Cesium.Color.fromCssColorString('#2076DF'))   //12级  32.6-36.9m/s
                colorTable.insert(36.9, new Cesium.Color.fromCssColorString('#1A71DE'))  //13级  36.9-41.4m/s
                colorTable.insert(41.4, new Cesium.Color.fromCssColorString('#136DDD'))  //14级  41.4-46.1m/s
                colorTable.insert(46.1, new Cesium.Color.fromCssColorString('#0D68DB'))  //15级  46.1-50.9m/s
                colorTable.insert(50.9, new Cesium.Color.fromCssColorString('#0663DA'))  //16级  50.9-56.0m/s
                colorTable.insert(56, new Cesium.Color.fromCssColorString('#005ED9'))  //17级  >56.0m/s

                fieldLayer.particleVelocityFieldEffect.colorTable = colorTable;

                $('#toolbar').show();
                $('#loadingbar').remove();
                document.getElementById("startField").onclick = function () {
                    fieldLayer.fieldData = particleWindField;
                };
            }
        });

        $("#show").on("input change", function () {
            viewer.scene.bloomEffect.show = this.checked;
        });

        //泛光亮度阈值调节
        $("#threshold").on("input change", function () {
            viewer.scene.bloomEffect.threshold = this.value;
        });

        //泛光强度
        $("#bloomIntensity").on("input change", function () {
            $("#current_bloomIntensity").text(this.value);
            viewer.scene.bloomEffect.bloomIntensity = this.value;
        });

        //场图层的可见性
        $("#fieldLayerVisible").on("input change", function () {
            fieldLayer.visible = this.checked;
        });

        //场图层数据切换
        $("#changeFieldData").on("click", function () {
            if (dataChanged) {
                fieldLayer.fieldData = particleWindField;
            } else {
                fieldLayer.fieldData = particleWindInverseField;
            }
            dataChanged = !dataChanged;
        });

        //粒子大小控制
        $("#particleSize").on("input change", function () {
            fieldLayer.particleVelocityFieldEffect.particleSize = this.value;
        });

        //粒子的生命周期
        $("#particleLife").on("input change", function () {
            var lifeRange = [this.value * 1000.0, this.value * 1000.0 + 5000.0];
            fieldLayer.particleVelocityFieldEffect.particleLifeRange = lifeRange;
        });

        //粒子密度
        $("#particleDensity").on("input change", function () {
            fieldLayer.particleVelocityFieldEffect.paricleCountPerDegree = this.value;
        });

        //粒子速度
        $("#particleVelocityScale").on("input change", function () {
            fieldLayer.particleVelocityFieldEffect.velocityScale = this.value * 100.0;
        });
    }

    if (typeof Cesium !== 'undefined') {
        window.startupCalled = true;
        onload(Cesium);
    }
</script>
</body>
</html>
